Bootstrap: docker 
From: continuumio/anaconda3 
Stage: build

%environment
    export PATH="/$HOME/.cargo/bin:/opt/nextflow:/opt/conda/bin:/opt/TOGA2:/opt/TOGA2/bin:/opt/TOGA2/bin/prank:/opt/TOGA2/bin/iqtree2:/opt/TOGA2/bin/intronIC:$PATH"
    export SHELL=/bin/bash
    export NXF_HOME=$TMPDIR/.nextflow

%post

    ## install curl, Java, mailx, and git
    apt-get update && apt-get install -y \
        curl \
        openjdk-17-jdk \
        git \
        bsd-mailx \
        && rm -rf /var/lib/apt/lists/*

    ## install cargo
    curl https://sh.rustup.rs -sSf | sh
    . "$HOME/.cargo/env" 

    ## install Nextflow
    mkdir -p /opt/nextflow
    curl -sSL https://get.nextflow.io | bash
    mv nextflow /opt/nextflow/nextflow
    chmod +x /opt/nextflow/nextflow
    export PATH=/opt/nextflow/:$PATH

    ## install gcc
    apt-get -y update
    apt -y install build-essential

    ## facilitate installation by removing conflicting packages
    python3 -m pip uninstall -y gensim numba datashader
    python3 -m pip install streamlit --upgrade --root-user-action=ignore
    python3 -m pip install pyarrow --upgrade --root-user-action=ignore
    python3 -m pip install bottleneck --upgrade --root-user-action=ignore

    ## clone the current TOGA2 repo
    git clone https://github.com/hillerlab/TOGA2 /opt/TOGA2
    ## build TOGA2, install/update the necessary third-party requirements
    cd /opt/TOGA2 && make

    ## make sure that bash is the default shell in the container
    sed -i 's/required/sufficient/g' /etc/pam.d/chsh
    rm /bin/sh && ln -f /bin/bash /bin/sh

    ## change permissions for mailx configuration file to ensure proper troubleshooting
    chmod 0640 /var/lib/exim4/config.autogenerated

    ## looks like we're all set

%runscript
    export NXF_HOME=$TMPDIR/.nextflow
    cd /opt/TOGA2
    exec toga2.py "$@"

%labels
    Author SGN Hillerlab
    Version 1.0