Bootstrap: docker 
From: continuumio/anaconda3 
Stage: build

## This is an example Singularity container build for Slurm compatibility

%environment
    export PATH=$HOME/.cargo/bin:/opt/nextflow:/opt/conda/bin:/opt/TOGA2:/opt/TOGA2/bin:/opt/TOGA2/bin/prank:/opt/TOGA2/bin/iqtree2:/opt/TOGA2/bin/intronIC:$PATH
    export SHELL=/bin/bash
    export NXF_HOME=$TMPDIR/.nextflow
    # source /opt/TOGA2/toga2/bin/activate

%post
    ## install curl, Java, mailx, and git
    apt-get update && apt-get install -y \
        curl \
        openjdk-17-jdk \
        git \
        bsd-mailx \
        mailutils \
        && rm -rf /var/lib/apt/lists/*

    ## install cargo
    curl https://sh.rustup.rs -sSf | sh -s -- -y
    . "$HOME/.cargo/env" 

    ## install Nextflow
    mkdir -p /opt/nextflow
    curl -sSL https://get.nextflow.io | bash
    mv nextflow /opt/nextflow/nextflow
    chmod +x /opt/nextflow/nextflow
    export PATH=/opt/nextflow/:$PATH

    ## install gcc
    apt-get -y update
    apt -y install build-essential

    ## facilitate installation by removing conflicting packages
    python3 -m pip uninstall -y gensim numba datashader
    python3 -m pip install streamlit --upgrade --root-user-action=ignore
    python3 -m pip install pyarrow --upgrade --root-user-action=ignore
    python3 -m pip install bottleneck --upgrade --root-user-action=ignore

    ## make sure that bash is the default shell in the container
    sed -i 's/required/sufficient/g' /etc/pam.d/chsh
    rm /bin/sh && ln -f /bin/bash /bin/sh

    ## clone the current TOGA2 repo
    git clone --recurse-submodules https://github.com/hillerlab/TOGA2 /opt/TOGA2
    cd /opt/TOGA2
    ## create TOGA2 running environment
    # python3 -m venv toga2
    # . toga2/bin/activate
    ## build TOGA2, install/update the necessary third-party requirements
    make

    ## create a dummy user for Slurm
    adduser --disabled-password --gecos "" slurm

    ## looks like we're all set

%runscript
    ## by default the container is configured for SLURM; modify the passwd
    ## as suggested at https://info.gwdg.de/wiki/doku.php?id=wiki:hpc:usage_of_slurm_within_a_singularity_container
    echo “slurmadmin:x:300:300::/opt/slurm/slurm:/bin/false” >> /etc/passwd
    echo “slurmadmin:x:300:” >> /etc/group
    cd /opt/TOGA2
    # source toga2/bin/activate
    # export LD_LIBRARY_PATH=/usr/lib64:$LD_LIBRARY_PATH
    export SLURM_CONF=$SLURM_CONF
    export NXF_HOME=$TMPDIR/.nextflow
    export EXEC_DIR=$EXEC_DIR
    # export LD_LIBRARY_PATH=/host/usr/lib64:$LD_LIBRARY_PATH
    export PATH=$EXEC_DIR:$HOME/.cargo/bin:/opt/nextflow:/opt/conda/bin:/opt/TOGA2:/opt/TOGA2/bin:/opt/TOGA2/bin/prank:/opt/TOGA2/bin/iqtree2:/opt/TOGA2/bin/intronIC:$PATH
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$LIB_DIR
    # exec toga2.py "$@"
    # ./toga2.py
    exec "$@"

%labels
    Author SGN Hillerlab
    Version 1.0